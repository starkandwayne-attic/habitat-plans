#!/bin/sh

set -e

exec 2>&1

echo "Starting PostgreSQL"

export PGDATA={{pkg.svc_data_path}}

cat > {{pkg.svc_config_path}}/postgresql.local.conf <<-LOCAL
# Auto-generated memory defaults created at service start by Habitat
effective_cache_size=$(awk '/MemTotal/ {printf( "%.0f\n", ($2 / 1024 / 4) *3 )}' /proc/meminfo)MB
shared_buffers=$(awk '/MemTotal/ {printf( "%.0f\n", $2 / 1024 / 4 )}' /proc/meminfo)MB
maintenance_work_mem=$(awk '/MemTotal/ {printf( "%.0f\n", $2 / 1024 / 16 )}' /proc/meminfo)MB
work_mem=$(awk '/MemTotal/ {printf( "%.0f\n", ($2 / 1024 / 4) *3 / (100*3) )}' /proc/meminfo)MB
temp_buffers=$(awk '/MemTotal/ {printf( "%.0f\n", ($2 / 1024 / 4) *3 / (100*3) )}' /proc/meminfo)MB
LOCAL

chown -R hab:hab {{pkg.svc_data_path}}

exec chpst -U hab:hab -u hab:hab postmaster \
  -c config_file={{pkg.svc_config_path}}/postgresql.conf

~
